# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

kurut-bot is a Telegram bot for selling VPN subscriptions (WireGuard-based). It handles user registration, subscription management, payment processing via YooKassa, and WireGuard server management. The bot supports Russian and Kyrgyz languages.

## Common Commands

```bash
# Build
make build                    # Build binary to bin/kurut-bot
make run                      # Build and run

# Testing
make test                     # Run unit tests (short mode)
make test-all                 # Run all tests including integration
make test-cover               # Run tests with coverage report

# Linting
make lint                     # Run golangci-lint
make fix-lint                 # Auto-fix lint issues

# Database migrations (SQLite)
make migrate-up               # Apply all migrations
make migrate-down             # Rollback last migration
make migrate-status           # Show migration status
make create-migration name=X  # Create new migration
make db-reset                 # Reset database completely

# Development setup
make install                  # Install dev tools (golangci-lint, ogen, mockgen, gowrap)
```

## Architecture

### Entry Point & Initialization
- `cmd/bot/main.go` - Application entry, starts Telegram bot, HTTP servers, and worker manager
- `internal/env/setup.go` - Environment initialization, loads config from env vars via godotenv
- `internal/env/services.go` - Dependency injection, wires up all services
- `internal/config/config.go` - Configuration struct with env tags (TELEGRAM_, MARZBAN_, YOOKASSA_, WIREGUARD_ prefixes)

### Telegram Bot Layer (`internal/telegram/`)
- `router.go` - Central command/callback dispatcher, routes by state prefix
- `flows/` - Multi-step conversation flows (buysub, renewsub, starttrial, createtariff, etc.)
- `states/` - State machine for tracking user conversation state
- `cmds/` - Simple commands (my_subs, stats)

Flow handlers follow a pattern: each flow has states prefixed uniquely (e.g., `ubs_` for buysub, `act_` for createtariff). The router checks state prefix to delegate to the appropriate handler.

### Business Logic (`internal/stories/`)
- `users/` - User management
- `subs/` - Subscription management
- `subs/createsubs/` - Subscription creation logic
- `tariffs/` - Tariff/pricing plans
- `payment/` - YooKassa payment integration

### Infrastructure (`internal/infra/`)
- `sqlite3/` - SQLite database client
- `telegram/` - Telegram bot client wrapper
- `yookassa/` - Payment gateway client
- `wireguard/` - WireGuard server client with load balancer

### Storage (`internal/storage/`)
Single `storageImpl` struct implements all repository interfaces. Uses sqlx with squirrel query builder.

### Background Workers (`internal/workers/`)
- `retry-subscription/` - Retry failed subscription creations
- `expiration/` - Handle subscription expirations
- `notification/` - Send expiration notifications
- `healthcheck/` - Monitor WireGuard servers

Workers are managed by `workers.Manager` and run on cron schedules via robfig/cron.

### Generated Code (`pkg/marzban/`)
OpenAPI client generated by ogen. Generation is disabled in Makefile to preserve manual fixes.

## Key Patterns

- **State Machine**: User flows use state prefixes (e.g., `ubs_`, `act_`) stored per chat ID
- **Interface-based DI**: Services depend on interfaces defined in `contracts.go` files
- **Localization**: Messages loaded from `internal/localization/translations/*.yaml`
- **Admin Commands**: Guarded by `AdminChecker` using `TELEGRAM_ADMIN_TELEGRAM_IDS` env var

## Configuration

All config via environment variables (see `internal/config/config.go`):
- `TELEGRAM_BOT_TOKEN` - Telegram bot token
- `TELEGRAM_ADMIN_TELEGRAM_IDS` - Comma-separated admin IDs
- `MARZBAN_TOKEN`, `MARZBAN_API_URL` - Marzban VPN panel
- `YOOKASSA_SHOP_ID`, `YOOKASSA_SECRET_KEY` - Payment processing
- `WIREGUARD_*` - TLS certs for WireGuard API
- `DB_PATH` - SQLite database path (default: `./data/kurut.db`)

## CI/CD

GitHub Actions pipeline (`.github/workflows/ci.yml`):
- test -> lint -> build -> docker -> deploy
- Docker images pushed to ghcr.io
- Deploys to staging (main branch) or production (version tags)
