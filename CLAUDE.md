# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

kurut-bot is a Telegram bot for selling VPN subscriptions (WireGuard-based). It handles user registration, subscription management, payment processing via YooKassa, and WireGuard server management. The bot supports Russian and Kyrgyz languages.

## Common Commands

```bash
# Build
make build                    # Build binary to bin/kurut-bot
make run                      # Build and run

# Testing
make test                     # Run unit tests (short mode, GOGC=off for performance)
make test-all                 # Run all tests including integration (tags: all,dbtest)
make test-cover               # Run tests with coverage report (excludes stubs, mocks, generated code)
go test -short ./...          # Run a single package's tests
go test -run TestName ./...   # Run specific test by name

# Linting
make lint                     # Run golangci-lint
make fix-lint                 # Auto-fix lint issues

# Database migrations (SQLite)
make migrate-up               # Apply all migrations
make migrate-down             # Rollback last migration
make migrate-status           # Show migration status
make create-migration name=X  # Create new migration (requires goose)
make db-reset                 # Reset database completely (drops and recreates)

# Development setup
make install                  # Install dev tools (golangci-lint, ogen, mockgen, gowrap)
make docker-build             # Build Docker image
make docker-up                # Start with docker-compose
make docker-down              # Stop docker-compose
```

## Architecture

### Entry Point & Initialization
- `cmd/bot/main.go` - Application entry, starts Telegram bot, HTTP servers, and worker manager
- `internal/env/setup.go` - Environment initialization, loads config from env vars via godotenv
- `internal/env/services.go` - Dependency injection, wires up all services
- `internal/config/config.go` - Configuration struct with env tags (TELEGRAM_, MARZBAN_, YOOKASSA_, WIREGUARD_ prefixes)

### Telegram Bot Layer (`internal/telegram/`)

- `router.go` - Central command/callback dispatcher, routes by state prefix and callback data prefix
- `flows/` - Multi-step conversation flows (createsubforclient, createtariff, addserver)
- `states/` - State machine for tracking user conversation state (in-memory)
- `cmds/` - Simple commands (my_subs, stats, expiration, tariffs, servers, top_referrers)

**Routing logic:**

1. Commands (`/start`, `/create_sub`) are prioritized and clear any active state
2. Global callbacks (`cancel`, `main_menu`, `my_subscriptions`) work from any state
3. Callback data prefixes route to handlers: `pay_*` (payment), `trf_*` (tariffs), `srv_*` (servers), `exp_*` (
   expiration)
4. State prefixes route to flows: `acs_*` (create sub for client), `act_*` (create tariff), `asv_*` (add server)
5. Admin-only commands/callbacks are guarded by `AdminChecker`

Flow handlers follow a pattern: each flow has states prefixed uniquely. The router checks state prefix to delegate to
the appropriate handler.

### Business Logic (`internal/stories/`)
- `users/` - User management
- `subs/` - Subscription management
- `subs/createsubs/` - Subscription creation logic
- `tariffs/` - Tariff/pricing plans
- `payment/` - YooKassa payment integration

### Infrastructure (`internal/infra/`)
- `sqlite3/` - SQLite database client
- `telegram/` - Telegram bot client wrapper
- `yookassa/` - Payment gateway client
- `wireguard/` - WireGuard server client with load balancer

### Storage (`internal/storage/`)

Single `storageImpl` struct implements all repository interfaces (UserRepository, SubscriptionRepository,
TariffRepository, ServerRepository, OrderRepository, PaymentRepository). Uses sqlx with squirrel query builder for SQL
construction. All database fields mapped via `db` struct tags.

### Background Workers (`internal/workers/`)
- `retry-subscription/` - Retry failed subscription creations
- `expiration/` - Handle subscription expirations
- `notification/` - Send expiration notifications
- `healthcheck/` - Monitor WireGuard servers

Workers are managed by `workers.Manager` and run on cron schedules via robfig/cron.

### Generated Code (`pkg/marzban/`)
OpenAPI client generated by ogen. Generation is disabled in Makefile to preserve manual fixes.

## Key Patterns

- **State Machine**: User flows use state prefixes (e.g., `acs_`, `act_`, `asv_`) stored per chat ID in-memory
- **Interface-based DI**: Services depend on interfaces (no shared `contracts.go` files - interfaces defined where used)
- **Single Storage Implementation**: One `storageImpl` struct implements all repository interfaces for simplicity
- **Admin Commands**: Guarded by `AdminChecker` using `TELEGRAM_ADMIN_TELEGRAM_IDS` env var
- **Panic Recovery**: Main bot loop wraps each update with defer/recover, sends user-friendly error messages on panics
- **Error Handling**: Payment failures trigger automatic retry workers; subscription creation is async with worker retry

## Configuration

All config via environment variables (see `internal/config/config.go`):
- `TELEGRAM_BOT_TOKEN` - Telegram bot token
- `TELEGRAM_ADMIN_TELEGRAM_IDS` - Comma-separated admin IDs
- `MARZBAN_TOKEN`, `MARZBAN_API_URL` - Marzban VPN panel
- `YOOKASSA_SHOP_ID`, `YOOKASSA_SECRET_KEY` - Payment processing
- `WIREGUARD_*` - TLS certs for WireGuard API
- `DB_PATH` - SQLite database path (default: `./data/kurut.db`)

## CI/CD

GitHub Actions pipeline (`.github/workflows/ci.yml`):
- test -> lint -> build -> docker -> deploy
- Docker images pushed to ghcr.io
- Deploys to staging (main branch) or production (version tags)

## Important Notes

- **DO NOT regenerate** `pkg/marzban/` code - generation is disabled to preserve manual fixes
- State is stored **in-memory only** - will be lost on restart (flows should handle graceful degradation)
- Database is **SQLite** - migrations managed by goose, default path: `./data/kurut.db`
- Commands **clear state** - any active flow is cancelled when user sends a command
- Bot has **two user roles**: admins (full access) and assistants (can create subscriptions for clients)
